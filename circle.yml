dependencies:
  pre:
    - if ! chef -v; then
        if ! [ -f chefdk_0.6.2-1_amd64.deb ]; then
          wget https://opscode-omnibus-packages.s3.amazonaws.com/ubuntu/12.04/x86_64/chefdk_0.6.2-1_amd64.deb;
        fi;
        sudo dpkg -i chefdk_0.6.2-1_amd64.deb;
      fi
    - mkdir ~/.chef
    - cat > ~/.chef/knife.rb <<'_EOF'
current_dir = File.dirname(__FILE__)
log_level                :info
log_location             STDOUT
node_name                "#{ENV['CIRCLE_CI_MACHINE_USER_CLIENT_NAME']}"
client_key               ENV['CIRCLE_CI_MACHINE_USER_CLIENT_KEY']
validation_client_name   "#{ENV['CIRCLE_CI_CHEF_ORG_CLIENT']}"
validation_key           ENV['CIRCLE_CI_CHEF_ORG_KEY']
chef_server_url          "https://api.opscode.com/organizations/#{ENV['CIRCLE_CI_CHEF_ORG']}"
cache_type               'BasicFile'
cache_options(path:      "#{ENV['HOME']}/.chef/checksums")
_EOF
  cache_directories:
    - ./chefdk_0.6.2-1_amd64.deb
deployment:
  production:
    branch: release
    commands:
      - knife ssh "chef_environment:production $KNIFE_SEARCH" $KNIFE_COMMAND -a ipaddress -x $KNIFE_USER
  staging:
    branch: master
    commands:
      - knife ssh "chef_environment:staging $KNIFE_SEARCH" $KNIFE_COMMAND -a ipaddress -x $KNIFE_USER
